name: sateesh-comments-monitor

on:
  schedule:
    - cron: '30 4 * * 1-5'  # 10:00 AM AET / 4:30 AM IST on weekdays
  workflow_dispatch:  # Allow manual triggering

env:
  TZ: "Asia/Kolkata"  # Set timezone to IST for the entire workflow

jobs:
  monitor-sateesh-comments:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      
      - name: Monitor JIRA Comments for Sateesh
        id: jira-monitor
        run: |
          # Debug: Print version info
          echo "===== RUNNING JIRA COMMENTS MONITOR ====="
          echo "Version: March 15, 2025"
          
          # Create URL encoding function
          urlencode() {
            local string="${1}"
            local strlen=${#string}
            local encoded=""
            local pos c o
            
            for (( pos=0 ; pos<strlen ; pos++ )); do
              c=${string:$pos:1}
              case "$c" in
                [-_.~a-zA-Z0-9] ) o="${c}" ;;
                * ) printf -v o '%%%02x' "'$c"
              esac
              encoded+="${o}"
            done
            echo "${encoded}"
          }
          
          # JIRA Base URL for API and hyperlinks
          JIRA_BASE_URL="https://quantium.atlassian.net"
          JIRA_API_URL="${JIRA_BASE_URL}/rest/api/3/search"
          JIRA_BROWSE_URL="${JIRA_BASE_URL}/issues/?jql="
          
          # Jira API credentials
          AUTH_HEADER="Authorization: Basic ${{ secrets.JIRA_API_TOKEN }}"
          ACCEPT_HEADER="Accept: application/json"
          
          # Target team member
          TARGET_USER="Sateesh Gulivindala"
          
          echo "Checking for tickets with no external comments in last 7 days for: $TARGET_USER"
          
          # Time in IST and Sydney
          IST_TIME=$(date +"%I:%M %p IST")
          IST_DATE=$(date +"%d-%m-%Y")
          SYDNEY_TIME=$(TZ='Australia/Sydney' date +"%I:%M %p AEDT")
          
          # Base JQL for all active tickets assigned to Sateesh
          ACTIVE_JQL="assignee = \"$TARGET_USER\" AND status NOT IN (Closed, Resolved, Cancelled)"
          
          # Hard-coded URL for all active tickets
          ACTIVE_LINK="${JIRA_BROWSE_URL}assignee%20%3D%20%22Sateesh%20Gulivindala%22%20AND%20status%20NOT%20IN%20(Closed%2C%20Resolved%2C%20Cancelled)"
          
          # Get all active tickets that either:
          # 1. Have no comments at all, OR
          # 2. The last external comment was more than 7 days ago
          
          # This JQL finds tickets that have NO external comments in the last 7 days
          NO_RECENT_COMMENTS_JQL="$ACTIVE_JQL AND (
            NOT EXISTS (
              SELECT commentJsdPublic 
              FROM comment 
              WHERE commentJsdPublic = true AND commentedDate >= -7d
            )
          )"
          
          # URL for tickets with no external comments in the last 7 days
          # Hard-coded URL to match JIRA UI format
          NO_RECENT_COMMENTS_LINK="${JIRA_BROWSE_URL}assignee%20%3D%20%22Sateesh%20Gulivindala%22%20AND%20status%20NOT%20IN%20(Closed%2C%20Resolved%2C%20Cancelled)%20AND%20(NOT%20EXISTS%20(SELECT%20commentJsdPublic%20FROM%20comment%20WHERE%20commentJsdPublic%20%3D%20true%20AND%20commentedDate%20%3E%3D%20-7d))"
          
          # Get count of all active tickets
          SEARCH_URL="${JIRA_API_URL}?jql=$(urlencode "$ACTIVE_JQL")&maxResults=1"
          
          echo "Searching with JQL: $ACTIVE_JQL"
          SEARCH_RESPONSE=$(curl -s -H "$AUTH_HEADER" -H "$ACCEPT_HEADER" "$SEARCH_URL")
          
          # Get total results
          TOTAL_ACTIVE=$(jq -r '.total' <<< "$SEARCH_RESPONSE")
          echo "Found $TOTAL_ACTIVE active tickets assigned to $TARGET_USER."
          
          if [ "$TOTAL_ACTIVE" -eq 0 ]; then
            echo "No active tickets found for $TARGET_USER."
            exit 0
          fi
          
          # Get count of tickets with no external comments in last 7 days
          NO_RECENT_URL="${JIRA_API_URL}?jql=$(urlencode "$NO_RECENT_COMMENTS_JQL")&maxResults=1"
          NO_RECENT_RESPONSE=$(curl -s -H "$AUTH_HEADER" -H "$ACCEPT_HEADER" "$NO_RECENT_URL")
          NO_RECENT_COUNT=$(jq -r '.total' <<< "$NO_RECENT_RESPONSE")
          
          echo "Found $NO_RECENT_COUNT tickets with no external comments in the last 7 days."
          
          # Create message for Slack
          MESSAGE="ðŸ“Š *JIRA Comment Status for Sateesh Gulivindala*\n\n*Status Update* ($SYDNEY_TIME / $IST_TIME)\n"
          MESSAGE+="â€¢ Total active tickets: <${ACTIVE_LINK}|${TOTAL_ACTIVE}>\n"
          
          if [ $NO_RECENT_COUNT -gt 0 ]; then
            # Show the count of tickets with no recent external comments
            MESSAGE+="â€¢ Tickets with no external comments in the last 7 days: <${NO_RECENT_COMMENTS_LINK}|${NO_RECENT_COUNT}>"
          else
            MESSAGE+="â€¢ *All tickets have external comments in the last 7 days* âœ…"
          fi
          
          # Send to Slack using a cleaner approach
          cat > payload.json << EOF
          {"text": "$(echo "$MESSAGE" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')"}
          EOF
          
          curl -s -X POST \
               -H "Content-type: application/json" \
               --data @payload.json \
               ${{ secrets.SLACK_WEBHOOK_URL }}